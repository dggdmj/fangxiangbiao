(function(){window.H5lock=function(a){this.height=a.height;this.width=a.width;this.chooseType=Number(window.sessionStorage.getItem("chooseType"))||a.chooseType};H5lock.prototype.drawCle=function(a,b){this.ctx.strokeStyle="#CFE6FF";this.ctx.lineWidth=2;this.ctx.beginPath();this.ctx.arc(a,b,this.r,0,Math.PI*2,true);this.ctx.closePath();this.ctx.stroke()};H5lock.prototype.drawPoint=function(){for(var a=0;a<this.lastPoint.length;a++){this.ctx.fillStyle="#CFE6FF";this.ctx.beginPath();this.ctx.arc(this.lastPoint[a].x,this.lastPoint[a].y,this.r/2,0,Math.PI*2,true);this.ctx.closePath();this.ctx.fill()}};H5lock.prototype.drawStatusPoint=function(b){for(var a=0;a<this.lastPoint.length;a++){this.ctx.strokeStyle=b;this.ctx.beginPath();this.ctx.arc(this.lastPoint[a].x,this.lastPoint[a].y,this.r,0,Math.PI*2,true);this.ctx.closePath();this.ctx.stroke()}};H5lock.prototype.drawLine=function(a,c){this.ctx.beginPath();this.ctx.lineWidth=3;this.ctx.moveTo(this.lastPoint[0].x,this.lastPoint[0].y);for(var b=1;b<this.lastPoint.length;b++){this.ctx.lineTo(this.lastPoint[b].x,this.lastPoint[b].y)}this.ctx.lineTo(a.x,a.y);this.ctx.stroke();this.ctx.closePath()};H5lock.prototype.createCircle=function(){var f=this.chooseType;var d=0;this.r=this.ctx.canvas.width/(2+4*f);this.lastPoint=[];this.arr=[];this.restPoint=[];var c=this.r;for(var b=0;b<f;b++){for(var a=0;a<f;a++){d++;var e={x:a*4*c+3*c,y:b*4*c+3*c,index:d};this.arr.push(e);this.restPoint.push(e)}}this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);for(var b=0;b<this.arr.length;b++){this.drawCle(this.arr[b].x,this.arr[b].y)}};H5lock.prototype.getPosition=function(c){var b=c.currentTarget.getBoundingClientRect();var a={x:c.touches[0].clientX-b.left,y:c.touches[0].clientY-b.top};return a};H5lock.prototype.update=function(a){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);for(var b=0;b<this.arr.length;b++){this.drawCle(this.arr[b].x,this.arr[b].y)}this.drawPoint(this.lastPoint);this.drawLine(a,this.lastPoint);for(var b=0;b<this.restPoint.length;b++){if(Math.abs(a.x-this.restPoint[b].x)<this.r&&Math.abs(a.y-this.restPoint[b].y)<this.r){this.drawPoint(this.restPoint[b].x,this.restPoint[b].y);this.lastPoint.push(this.restPoint[b]);this.restPoint.splice(b,1);break}}};H5lock.prototype.checkPass=function(d,b){var e="",c="";for(var a=0;a<d.length;a++){e+=d[a].index+d[a].index}for(var a=0;a<b.length;a++){c+=b[a].index+b[a].index}return e===c};H5lock.prototype.storePass=function(a){if(this.pswObj.step==1){if(this.checkPass(this.pswObj.fpassword,a)){this.pswObj.step=99;this.pswObj.spassword=a;document.getElementById("title").innerHTML="密码保存成功";this.drawStatusPoint("#2CFF26");var c="";for(var b=0;b<a.length;b++){c+=a[b].index+a[b].index}$(".nine_password").val(c)}else{document.getElementById("title").innerHTML="两次不一致，重新输入";this.drawStatusPoint("red");delete this.pswObj.step}}else{if(this.pswObj.step==2){if(this.checkPass(this.pswObj.spassword,a)){document.getElementById("title").innerHTML="解锁成功";this.drawStatusPoint("#2CFF26")}else{this.drawStatusPoint("red");document.getElementById("title").innerHTML="解锁失败"}}else{this.pswObj.step=1;this.pswObj.fpassword=a;document.getElementById("title").innerHTML="再次输入"}}};H5lock.prototype.makeState=function(){if(this.pswObj.step==2){document.getElementById("updatePassword").style.display="block";document.getElementById("title").innerHTML="请解锁"}else{if(this.pswObj.step==1){document.getElementById("updatePassword").style.display="none"}else{document.getElementById("updatePassword").style.display="none"}}};H5lock.prototype.setChooseType=function(a){chooseType=a;init()};H5lock.prototype.updatePassword=function(){window.sessionStorage.removeItem("passwordxx");window.sessionStorage.removeItem("chooseType");this.pswObj={};document.getElementById("title").innerHTML="绘制解锁图案";this.reset()};H5lock.prototype.initDom=function(){var a=document.createElement("div");var b='<h4 id="title" class="title">绘制图案</h4>'+'<a id="updatePassword" style="position: absolute;right: 5px;top: 5px;color:#fff;font-size: 10px;display:none;">重置密码</a>'+'<canvas id="canvas" width="300" height="300" style="display: inline-block;margin-left:auto;margin-right:auto;"></canvas>';a.setAttribute("style","position: absolute;top:0;left:0;right:0;bottom:0; text-align:center;");a.innerHTML=b;document.getElementById("nine_box").appendChild(a)};H5lock.prototype.init=function(){this.initDom();this.pswObj={};this.lastPoint=[];this.makeState();this.touchFlag=false;this.canvas=document.getElementById("canvas");this.ctx=this.canvas.getContext("2d");this.createCircle();this.bindEvent()};H5lock.prototype.reset=function(){this.makeState();this.createCircle()};H5lock.prototype.bindEvent=function(){var a=this;this.canvas.addEventListener("touchstart",function(d){d.preventDefault();var b=a.getPosition(d);for(var c=0;c<a.arr.length;c++){if(Math.abs(b.x-a.arr[c].x)<a.r&&Math.abs(b.y-a.arr[c].y)<a.r){a.touchFlag=true;a.drawPoint(a.arr[c].x,a.arr[c].y);a.lastPoint.push(a.arr[c]);a.restPoint.splice(c,1);
break}}},false);this.canvas.addEventListener("touchmove",function(b){if(a.touchFlag){a.update(a.getPosition(b))}},false);this.canvas.addEventListener("touchend",function(b){if(a.touchFlag){a.touchFlag=false;a.storePass(a.lastPoint);setTimeout(function(){a.reset()},300)}},false);document.addEventListener("touchmove",function(b){b.preventDefault()},false);document.getElementById("updatePassword").addEventListener("click",function(){a.updatePassword()})}})();